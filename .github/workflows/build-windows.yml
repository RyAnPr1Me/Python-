name: Build Windows Binary

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write  # Needed for creating releases
      actions: read
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup LLVM
      run: |
        choco install llvm --version=15.0.7 -y
        echo "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        
    - name: Verify LLVM installation
      run: |
        llvm-config --version
        clang --version
        
    - name: Setup CMake
      uses: lukka/get-cmake@latest
      
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DLLVM_DIR="C:\Program Files\LLVM\lib\cmake\llvm" -DBUILD_TESTING=OFF
      
    - name: Build
      run: |
        cd build
        cmake --build . --config Release --parallel --target py++c p++
        
    - name: List build outputs
      run: |
        Get-ChildItem -Path build\Release -Recurse
        
    - name: Create distribution package
      run: |
        mkdir dist
        mkdir dist\bin
        mkdir dist\lib
        mkdir dist\include
        mkdir dist\examples
        
        # Copy binaries
        Copy-Item -Path "build\Release\py++c.exe" -Destination "dist\bin\"
        Copy-Item -Path "build\Release\p++.exe" -Destination "dist\bin\"
        
        # Copy runtime library if it exists
        if (Test-Path "build\Release\py++-runtime.lib") {
          Copy-Item -Path "build\Release\py++-runtime.lib" -Destination "dist\lib\"
        }
        
        # Copy headers
        Copy-Item -Path "include\*" -Destination "dist\include\" -Recurse
        
        # Copy examples
        Copy-Item -Path "examples\*" -Destination "dist\examples\" -Recurse
        
        # Copy documentation
        Copy-Item -Path "README.md" -Destination "dist\"
        
        # Create a batch file for easy setup
        @"
        @echo off
        echo Python++ (p++) Setup
        echo ===================
        echo.
        echo Adding Python++ to your PATH...
        setx PATH "%~dp0bin;%PATH%"
        echo.
        echo Python++ has been added to your PATH.
        echo Please restart your terminal for changes to take effect.
        echo.
        echo Usage:
        echo   p++ script.py     - Compile and run a Python++ script
        echo   py++c script.py   - Compile a Python++ script to executable
        echo.
        pause
        "@ | Out-File -FilePath "dist\setup.bat" -Encoding ASCII
        
        # Create a README for the distribution
        @"
        # Python++ Windows Distribution
        
        ## Installation
        
        1. Extract this archive to a directory of your choice
        2. Run setup.bat to add Python++ to your PATH
        3. Restart your terminal
        
        ## Usage
        
        ### Run a Python++ script directly:
        ```
        p++ script.py
        p++ script.py+
        ```
        
        ### Compile a script to an executable:
        ```
        py++c script.py -o myprogram
        py++c script.py+ -o myprogram
        ```
        
        ### File Association
        
        To associate .py+ files with the p++ runner:
        
        1. Right-click on a .py+ file
        2. Select "Open with" -> "Choose another app"
        3. Click "More apps" -> "Look for another app on this PC"
        4. Navigate to the bin folder and select p++.exe
        5. Check "Always use this app to open .py+ files"
        
        Alternatively, run this command in an administrator command prompt:
        ```
        assoc .py+=PythonPlusPlus
        ftype PythonPlusPlus="%CD%\bin\p++.exe" "%1" %*
        ```
        
        ## Examples
        
        Check the examples folder for sample Python++ programs:
        - examples/fibonacci.py - Fibonacci calculation
        - examples/basic_operations.py - Basic Python operations
        - examples/functions.py - Function definitions and calls
        
        ## Documentation
        
        See README.md for more information about Python++.
        "@ | Out-File -FilePath "dist\INSTALL.md" -Encoding UTF8
        
    - name: Create ZIP archive
      run: |
        $version = if ($env:GITHUB_REF -match 'refs/tags/(.*)') { $matches[1] } else { "latest" }
        Compress-Archive -Path dist\* -DestinationPath "python-plusplus-windows-$version.zip"
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: python-plusplus-windows
        path: python-plusplus-windows-*.zip
        retention-days: 90
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: python-plusplus-windows-*.zip
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
